# This file is part of reproducible-macports. It is subject to the licence terms in the COPYRIGHT file found in the top-level directory of this distribution and at https://raw.githubusercontent.com/raphaelcohn/reproducible-macports/master/COPYRIGHT. No part of reproducible-macports, including this file, may be copied, modified, propagated, or distributed except according to the terms contained in the COPYRIGHT file.
# Copyright Â© 2019 The developers of reproducible-macports. See the COPYRIGHT file in the top-level directory of this distribution and at https://raw.githubusercontent.com/raphaelcohn/reproducible-macports/master/COPYRIGHT.


environment_cd()
{
	local folderPath="$1"
	cd "$folderPath" 1>/dev/null 2>/dev/null
}

environment_cdBack()
{
	cd - 1>/dev/null 2>/dev/null
}

depends git
environment_gitClean()
{
	local folderPath="$1"
	
	git -C "$folderPath" clean --quiet --force -d -x
}

reproducible_macports_setVariables()
{
	reproducible_macports_sourceFolderPath="$(pwd)"/source/macports-base
	reproducible_macports_prefixFolderPath="$(pwd)"/prefix
	
	reproducible_macports_currentMacportsVersion="$(git -C "$reproducible_macports_sourceFolderPath" log --pretty=format:%H -n 1)"
	
	reproducible_macports_installedMacportsVersionFile="$reproducible_macports_prefixFolderPath"/.macports.version
	
	reproducible_macports_defaultPath=/usr/bin:/bin:/usr/sbin:/sbin
}

depends xcode-select
reproducible_macports_installXcodeCommandLineTools()
{
	set +e
		xcode-select --install 2>/dev/null
	set -e
}

depends git head
reproducible_macports_shouldInstall()
{
	shouldInstall=true
	if [ -f "$reproducible_macports_installedMacportsVersionFile" ]; then
		if [ -r "$reproducible_macports_installedMacportsVersionFile" ]; then
			local installedVersion="$(head -n 1 $reproducible_macports_installedMacportsVersionFile)"
			if [ "$installedVersion" = "$reproducible_macports_currentMacportsVersion" ]; then
				shouldInstall=false
			fi
		fi
	fi
}

depends rm mkdir
reproducible_macports_clean()
{
	if $shouldInstall; then
		rm -rf "$reproducible_macports_prefixFolderPath"
		mkdir -m 0700 -p "$reproducible_macports_prefixFolderPath"
	fi
}

depends id make
reproducible_macports_compile()
{
	environment_gitClean "$reproducible_macports_sourceFolderPath"
	environment_cd "$reproducible_macports_sourceFolderPath"

		local user="$(id -u -n)"
		local group="$(id -g -n)"
		
		env -i PATH="$reproducible_macports_defaultPath" ./configure \
			--enable-readline \
			--prefix="$reproducible_macports_prefixFolderPath" \
			--without-startupitems \
			--with-unsupported-prefix \
			--with-no-root-privileges \
			--with-install-user="$user" \
			--with-install-group="$group" \
			--with-macports-user="$user" \
			--with-directory-mode=0700 \
			--with-applications-dir="$reproducible_macports_prefixFolderPath"/Applications
		env -i PATH="$reproducible_macports_defaultPath" make
		env -i PATH="$reproducible_macports_defaultPath" make install
	
	environment_cdBack
	environment_gitClean "$reproducible_macports_sourceFolderPath"
	
	printf '%s\n' "$reproducible_macports_currentMacportsVersion" >"$reproducible_macports_installedMacportsVersionFile"
}

reproducible_macports_install()
{
	local shouldInstall
	reproducible_macports_shouldInstall
	if $shouldInstall; then
		reproducible_macports_installXcodeCommandLineTools
		reproducible_macports_clean
		reproducible_macports_compile
	fi
}
